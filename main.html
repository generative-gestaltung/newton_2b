<!DOCTYPE HTML>
<html>

  <head>
    
    <script src="settings.js"></script>
    <script src="util.js"></script>
    <script src="comets.js"></script>
    <script src="player.js"></script>
    <script src="planet.js"></script>
    <script>

    

    var initComets = function() {
      R = 2000;
      for (i=0; i<N_COMETS; i++) {
        arg = Math.PI*2*i/N_COMETS;
        pX = R*Math.sin (arg) + Math.random()*2000-1000;
        pY = R*Math.cos (arg) + Math.random()*2000-1000;;

        vX =  Math.cos(arg)*20;
        vY = -Math.sin(arg)*20;

        comets[i] = new Comet (pX, pY, vX, vY, Math.random()*100+100);
      }
    }


    // VARIABLES
    var canvas;
    var g;
    var frameCount;
    var N = 10;
    var W = 0;
    var H = 0;
    var PI = Math.PI;
    var ZOOM = 1.0;

    // classes
    var color = {};
    color.r = 0;
    color.g = 100;
    color.b = 100;

    var offset = {};
    offset.x = 0;
    offset.y = 0;

    var player = new Player (0,0);
    var planet = new Planet (0,0,PLANET_RADIUS);
    var comets = [];


    var init = function() {
      canvas = document.getElementById("myCanvas");
      W = canvas.width;
      H = canvas.height;
      c = canvas.getContext('2d');
      frameCount = 0;

      initComets();
      canvas.addEventListener("mousewheel", function(e) {
        ZOOM += e.wheelDeltaY*0.002;
        ZOOM = Util.constrain(ZOOM, 0.02, 1.5);
      });

      document.addEventListener("keydown", function (e) {
        if (e.which==37) {
          player.speed+=0.3;
        }
        else if (e.which==39) {
          player.speed-=0.3;
        }
      });
    }



    var stroke = function (r, g, b) {
      c.strokeStyle = "rgb("+r+","+g+","+b+")";
    }

    var fill = function (r,g,b) {
      c.fillStyle = "rgb("+r+","+g+","+b+")";
    }

    var sin = function (f, phase, A) {
      return Math.sin(frameCount*f+phase)*A/2+A/2;
    }

    var draw = function() {

      c.save();
      c.clearRect (0, 0, canvas.width, canvas.height);  

      
      ZOOM = 30.0 / (Math.abs(player.speed)+20.0);
      c.scale (ZOOM, ZOOM);
      c.translate (W/2/ZOOM, H/2/ZOOM);  
      //c.scale (ZOOM,ZOOM);


      r = planet.getRound(player.angle);
      c.rotate(player.angle+Math.PI);
      
      c.translate (-r.x, -r.y);
      
      console.log(r);
      planet.draw (1000);
      player.update (planet);
      player.draw (planet);

      for (i=0; i<N_COMETS; i++) {
        comets[i].update(planet);
        comets[i].draw();
      }
      c.restore();
      frameCount = frameCount+1;
      requestAnimationFrame(draw);
    };

    </script>
  </head>

  <body style="overflow:hidden">

    <canvas id="myCanvas" width="1280" height="800"></canvas>
    <script>
      init();
      draw();		
    </script>
  </body>

</html>      
