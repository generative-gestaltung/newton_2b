<!DOCTYPE HTML>
<html>

  <head>
    
    <script src="settings.js"></script>
    <script src="util.js"></script>
    <script src="comets.js"></script>
    <script src="player.js"></script>
    <script src="planet.js"></script>
    <script>


    SUBCOMETS = 4;
    var initComets = function() {
      R = 9000;
      for (i=0; i<N_COMETS; i++) {
        R = i*2+8000;
        arg = Math.PI*2*i/N_COMETS;
        pX = 8000; //*R*Math.sin (arg) + Math.random()*2000-1000;
        pY = i*100-80000; //R*Math.cos (arg) + Math.random()*2000-1000;;

        vX =  Math.cos(arg)*20;
        vY = -Math.sin(arg)*20;

        comets[i*SUBCOMETS] = new Comet (pX, pY, vX, vY, Util.rand(30,300),true);
        comets[i*SUBCOMETS].vel.y = -Util.rand(50,100);
        comets[i*SUBCOMETS+1] = new Comet(0,0,0,0,0,false);
        comets[i*SUBCOMETS+2] = new Comet(0,0,0,0,0,false);
        comets[i*SUBCOMETS+3] = new Comet(0,0,0,0,0,false);
      }
    }

    var initPlanets = function () {
      var R = 10000;
      for (var i=0; i<N_PLANETS; i++) {
        var phase = Util.rand(0, Math.PI*2);
        x = R*Math.cos(phase);
        y = R*Math.sin(phase);
        speed = Math.random()*0.4+0.4;
        //speed = 0;
        planets[i] = new Planet (x,y,0,0,Util.rand(PLANET_R_MIN, PLANET_R_MAX),R, speed);
        R += Util.rand(6000,10000);
      }
    }

    // VARIABLES
    var canvas;
    var g;
    var frameCount;
    var N = 10;
    var W = 0;
    var H = 0;
    var PI = Math.PI;
    var ZOOM = 0.1;

    // classes
    var color = {};
    color.r = 0;
    color.g = 100;
    color.b = 100;

    var offset = {};
    offset.x = 0;
    offset.y = 0;

    var player = {};
    var planets = [];
    var comets = [];



    var init = function() {
      canvas = document.getElementById("myCanvas");
      W = canvas.width;
      H = canvas.height;
      c = canvas.getContext('2d');
      frameCount = 0;

      initComets();
      initPlanets();
      canvas.addEventListener("mousewheel", function(e) {
        ZOOM += e.wheelDeltaY*0.002;
        ZOOM = Util.constrain(ZOOM, 0.005, 1.5);
      });

      document.addEventListener("keydown", function (e) {
        if (e.which==37) {
          player.move(1);
        }
        else if (e.which==39) {
          player.move(-1);
        }
      });

      player = new Player (0,0, planets[0]);
      player.init(planets[0]);
    }



    var stroke = function (r, g, b) {
      c.strokeStyle = "rgb("+r+","+g+","+b+")";
    }

    var fill = function (r,g,b) {
      c.fillStyle = "rgb("+r+","+g+","+b+")";
    }

    var sin = function (f, phase, A) {
      return Math.sin(frameCount*f+phase)*A/2+A/2;
    }

    var draw = function() {

      c.save();
      c.fillStyle = "rgba(0,0,0,0.7)";
      c.fillRect (0, 0, canvas.width, canvas.height);  

      
      //ZOOM = 30.0 / (Math.abs(player.speed)+20.0);
      console.log(player.distanceToCenter);
      ZOOM = (player.distanceToCenter);
      ZOOM = (player.planet.R / ZOOM)*0.1;
      ZOOM = Util.constrain(ZOOM,0.02,8);
      c.scale (ZOOM, ZOOM);
      c.translate (W/2/ZOOM, H/2/ZOOM);  
      //c.scale (ZOOM,ZOOM);


      r = planets[0].getRound(0);
      c.rotate(player.phi+Math.PI);
      
      c.translate (-r.x, -r.y);
      
      for (var i=0; i<N_PLANETS; i++) {
        planets[i].update(i);
        planets[i].draw (1000);
      }
      
      
      player.update (planets[0]);
      player.draw (planets[0]);

      for (i=0; i<N_COMETS*SUBCOMETS; i++) {
        comets[i].update (planets);

        c.fillStyle = "#0000ff";
        
        for (var j=0; j<N_PLANETS; j++) {
          if (planets[j].isInside(comets[i].pos)>0) {
            comets[i].kill();
          }
        }

        var d = Math.sqrt(Math.pow((comets[i].pos.x-player.pos.x),2)+Math.pow((comets[i].pos.y-player.pos.y),2));

        if (d<comets[i].m && comets[i].alive) {


          if (comets[i].m>1) {
          var r0 = Util.rand(-24,24);
          var r1 = Util.rand(-24,24);

          comets[i]   = new Comet (comets[i].pos.x, comets[i].pos.y, 
                                   comets[i].vel.x+r0, comets[i].vel.y+r1, 
                                   comets[i].m/2, true);

          r0 = Util.rand(-24,24);
          r1 = Util.rand(-24,24);

          comets[i]   = new Comet (comets[i].pos.x+20, comets[i].pos.y, 
                                   comets[i].vel.x+r0, comets[i].vel.y+r1, 
                                   comets[i].m/2, true);
          }
          else {
            comets[i].kill(); 
          }
        }

        comets[i].draw();
      }    

      //c.fillStyle = "#ff9102"
      Util.circle(0,0,4000,255,145,2);
      c.fillStyle = "#000000";
      c.fill(); 
      c.restore();
      frameCount = frameCount+1;
      
      setTimeout(function() {
        requestAnimationFrame(draw);
      }, 1000 / 60);
    };

    </script>
  </head>

  <body style="overflow:hidden">

    <canvas id="myCanvas" width="1280" height="800"></canvas>
    <script>
      init();
      draw();		
    </script>
  </body>

</html>      
